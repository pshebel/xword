name: Frontend Release

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - frontend/**

# Required for OIDC authentication
permissions:
  id-token: write
  contents: write

env:
  AWS_REGION: us-east-1

jobs:
  build:
    name: Build project
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        cache-dependency-path: frontend/package-lock.json
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      working-directory: frontend
      run: npm ci
    
    - name: Build project
      working-directory: frontend
      run: npx expo export --platform web
      env:
        EXPO_PUBLIC_API_URL: ${{ secrets.API_URL }}

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: expo-package
        path: frontend/dist/*
        retention-days: 5

  deploy:
    name: Deploy project
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    environment: 
      name: dev
      url: ${{ vars.API_URL }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: expo-package
          path: ./dist

      - name: Configure AWS credentials using OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: GitHubActions-${{ github.run_id }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Verify AWS identity
        run: aws sts get-caller-identity

      - name: Update Distribution
        run: aws s3 sync ./dist s3://dev-xword --delete

      - name: Get CloudFront Distribution ID by Alias
        id: get-id
        run: |
          # Query distributions for the one containing 'xword.io' in its Aliases list
          DIST_ID=$(aws cloudfront list-distributions \
            --query "DistributionList.Items[?Aliases.Items && contains(Aliases.Items, 'xword.io')].Id" \
            --output text)
          
          if [ -z "$DIST_ID" ] || [ "$DIST_ID" == "None" ]; then
            echo "Error: Distribution with alias 'xword.io' not found."
            exit 1
          fi
          
          echo "DISTRIBUTION_ID=$DIST_ID" >> $GITHUB_OUTPUT

      - name: Invalidate CloudFront cache
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${{ steps.get-id.outputs.DISTRIBUTION_ID }} \
            --paths "/*"